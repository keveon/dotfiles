#!/usr/bin/env zsh

#MISE description="åŒæ­¥ Chezmoi dotfiles é…ç½®"
#MISE shell="zsh"
#USAGE flag "-f --force" help="å¼ºåˆ¶æ›´æ–°é…ç½®ï¼Œå¿½ç•¥æ—¶é—´é—´éš”"
#USAGE flag "-s --status" help="æ˜¾ç¤ºå½“å‰åŒæ­¥çŠ¶æ€"
#USAGE flag "-h --help" help="æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"

set -euo pipefail

# é»˜è®¤é…ç½®
DEFAULT_INTERVAL=86400  # 24å°æ—¶
LAST_UPDATE_FILE="$HOME/.cache/chezmoi_last_update"
CHEZMOI_DIR="${CHEZMOI_DIR:-$HOME/.local/share/chezmoi}"

# è§£æå‘½ä»¤è¡Œå‚æ•°
FORCE_UPDATE=false
SHOW_STATUS=false
SHOW_HELP=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -f|--force)
      FORCE_UPDATE=true
      shift
      ;;
    -s|--status)
      SHOW_STATUS=true
      shift
      ;;
    -h|--help)
      SHOW_HELP=true
      shift
      ;;
    *)
      echo "æœªçŸ¥å‚æ•°: $1"
      echo "ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
      exit 1
      ;;
  esac
done

# æ˜¾ç¤ºå¸®åŠ©
if [[ "$SHOW_HELP" == "true" ]]; then
  echo "ç”¨æ³•: mise run dotfiles:sync [é€‰é¡¹]"
  echo ""
  echo "é€‰é¡¹:"
  echo "  -f, --force    å¼ºåˆ¶æ›´æ–°é…ç½®ï¼Œå¿½ç•¥æ—¶é—´é—´éš”"
  echo "  -s, --status   æ˜¾ç¤ºå½“å‰åŒæ­¥çŠ¶æ€"
  echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
  echo ""
  echo "ç¯å¢ƒå˜é‡:"
  echo "  CHEZMOI_DIR    Chezmoi ç›®å½• (é»˜è®¤: ~/.local/share/chezmoi)"
  echo ""
  echo "ç¤ºä¾‹:"
  echo "  mise run dotfiles:sync              # æ£€æŸ¥å¹¶æ›´æ–°é…ç½®"
  echo "  mise run dotfiles:sync --force      # å¼ºåˆ¶æ›´æ–°é…ç½®"
  echo "  mise run dotfiles:sync --status     # æ˜¾ç¤ºçŠ¶æ€"
  exit 0
fi

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
should_update() {
    if [[ "$FORCE_UPDATE" == "true" ]]; then
        return 0
    fi

    local current_time=$(date +%s)

    if [[ ! -f "$LAST_UPDATE_FILE" ]]; then
        return 0
    fi

    local last_update=$(cat "$LAST_UPDATE_FILE" 2>/dev/null || echo "0")
    local time_diff=$((current_time - last_update))

    return $((time_diff < DEFAULT_INTERVAL))
}

# æ˜¾ç¤ºçŠ¶æ€
show_status() {
    if [[ ! -d "$CHEZMOI_DIR" ]]; then
        log_error "Chezmoi ç›®å½•ä¸å­˜åœ¨: $CHEZMOI_DIR"
        return 1
    fi

    cd "$CHEZMOI_DIR" || { log_error "æ— æ³•è®¿é—® Chezmoi ç›®å½•"; return 1; }

    echo "ğŸ“Š é…ç½®çŠ¶æ€:"

    if git rev-parse --git-dir >/dev/null 2>&1; then
        local local_head="unknown"
        local branch="unknown"
        local remote_head="unknown"

        local_head=$(git rev-parse --short HEAD 2>/dev/null) || local_head="unknown"
        branch=$(git branch --show-current 2>/dev/null) || branch="unknown"

        if git remote get-url origin >/dev/null 2>&1; then
            remote_head=$(git rev-parse --short "origin/$branch" 2>/dev/null) || remote_head="unknown"
        fi

        echo "   æœ¬åœ°åˆ†æ”¯: $branch"
        echo "   æœ¬åœ°æäº¤: $local_head"
        echo "   è¿œç¨‹æäº¤: $remote_head"

        if [[ -f "$LAST_UPDATE_FILE" ]]; then
            local last_update_time="unknown"
            last_update_time=$(date -r "$LAST_UPDATE_FILE" 2>/dev/null) || last_update_time="unknown"
            echo "   æœ€åæ›´æ–°: $last_update_time"
        else
            echo "   æœ€åæ›´æ–°: ä»æœª"
        fi

        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
        if [[ "$local_head" != "unknown" && "$remote_head" != "unknown" && "$local_head" != "$remote_head" ]]; then
            echo "   çŠ¶æ€: ğŸŸ¡ æœ‰æ›´æ–°å¯ç”¨"
        else
            echo "   çŠ¶æ€: ğŸŸ¢ å·²æ˜¯æœ€æ–°"
        fi
    else
        echo "   çŠ¶æ€: ğŸ”´ ä¸æ˜¯ Git ä»“åº“"
    fi
}

# æ‰§è¡ŒåŒæ­¥
sync_config() {
    if [[ ! -d "$CHEZMOI_DIR" ]]; then
        log_error "Chezmoi ç›®å½•ä¸å­˜åœ¨: $CHEZMOI_DIR"
        return 1
    fi

    if [[ ! -d "$CHEZMOI_DIR/.git" ]]; then
        log_error "ä¸æ˜¯ Git ä»“åº“ï¼Œæ— æ³•åŒæ­¥"
        return 1
    fi

    cd "$CHEZMOI_DIR" || { log_error "æ— æ³•è®¿é—® Chezmoi ç›®å½•"; return 1; }

    # æ£€æŸ¥è¿œç¨‹è¿æ¥
    if ! git remote get-url origin >/dev/null 2>&1; then
        log_error "æ²¡æœ‰é…ç½®è¿œç¨‹ä»“åº“"
        return 1
    fi

    # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
    if ! should_update; then
        log_info "é…ç½®æ£€æŸ¥é—´éš”æœªåˆ°ï¼Œè·³è¿‡æ›´æ–°"
        log_info "ä½¿ç”¨ --force å¼ºåˆ¶æ›´æ–°"
        return 0
    fi

    log_info "æ£€æŸ¥è¿œç¨‹æ›´æ–°..."

    # è·å–è¿œç¨‹ä¿¡æ¯
    if ! git fetch --quiet 2>/dev/null; then
        log_error "æ— æ³•è·å–è¿œç¨‹æ›´æ–°ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥"
        return 1
    fi

    # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
    local local_head=$(git rev-parse HEAD)
    local remote_head=$(git rev-parse origin/$(git branch --show-current) 2>/dev/null)

    if [[ "$local_head" == "$remote_head" ]]; then
        log_success "é…ç½®å·²æ˜¯æœ€æ–°"
        date +%s > "$LAST_UPDATE_FILE"
        return 0
    fi

    log_info "å‘ç°é…ç½®æ›´æ–°ï¼Œæ­£åœ¨åŒæ­¥..."

    # æ‰§è¡Œæ›´æ–°
    if git pull --rebase; then
        log_success "é…ç½®ä¸‹è½½å®Œæˆ"

        # åº”ç”¨é…ç½®
        log_info "åº”ç”¨é…ç½®å˜æ›´..."
        if chezmoi apply; then
            log_success "é…ç½®åº”ç”¨å®Œæˆï¼"

            # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
            local commit_count=$(git rev-list --count $local_head..$remote_head 2>/dev/null || echo "unknown")
            log_info "æ›´æ–°äº† $commit_count ä¸ªæäº¤"

            date +%s > "$LAST_UPDATE_FILE"
            return 0
        else
            log_error "é…ç½®åº”ç”¨å¤±è´¥"
            return 1
        fi
    else
        log_error "é…ç½®ä¸‹è½½å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
        log_info "è¯·æ‰‹åŠ¨å¤„ç†: cd $CHEZMOI_DIR && git status"
        return 1
    fi
}

# ä¸»é€»è¾‘
if [[ "$SHOW_STATUS" == "true" ]]; then
    show_status
else
    sync_config
fi
