#!/usr/bin/env zsh

#MISE description="初始化 Fd, 安装 Zsh 自动补全"

if command -v fd >/dev/null 2>&1; then
  {{- if eq .chezmoi.os "darwin" }}
  # macOS 上 brew 安装的 fd 会自动配置补全
  if command -v brew >/dev/null 2>&1 && brew list fd >/dev/null 2>&1; then
    echo "Fd 通过 Homebrew 安装，补全已自动配置"
  fi

  {{- else if eq .chezmoi.os "linux" }}
  # Linux 系统 - 从 fd 仓库获取更完整的补全脚本
  COMPLETION_DIR="{{ .chezmoi.homeDir }}/.local/share/zsh/site-functions"
  mkdir -p "$COMPLETION_DIR"

  if command -v curl >/dev/null 2>&1; then
    if curl -fsSL https://raw.githubusercontent.com/sharkdp/fd/master/contrib/completion/_fd -o "${COMPLETION_DIR}/_fd" 2>/dev/null; then
      echo "Fd Zsh 自动补全已安装到: ${COMPLETION_DIR}/_fd"
      echo "注意: 使用源码版本的补全脚本，功能更完整"
      echo "注意: .zshenv 已配置 fpath, 补全会自动生效"
    else
      echo "警告: 无法下载 Fd 自动补全，尝试使用生成的版本"
      if fd --gen-completions zsh 2>/dev/null > "${COMPLETION_DIR}/_fd"; then
        echo "Fd Zsh 自动补全已安装（生成版本）"
      else
        echo "警告: 无法安装 Fd 自动补全"
      fi
    fi
  else
    echo "警告: curl 未安装，尝试使用生成的版本"
    if fd --gen-completions zsh 2>/dev/null > "${COMPLETION_DIR}/_fd"; then
      echo "Fd Zsh 自动补全已安装（生成版本）"
    else
      echo "警告: 无法安装 Fd 自动补全"
    fi
  fi

  unset COMPLETION_DIR
  {{- end }}
fi